# 问题 5 — 完整建模（5 架无人机，每架至多 3 枚烟幕，干扰 M1,M2,M3；结果写入 `result3.xlsx`）

下面把问题 5 从 **变量→约束→运动学→遮蔽判定→目标函数→求解策略→输出映射** 全面公式化，给出可直接拿去编码、并能扩展到并行/大规模求解的实现思路与伪代码。所有物理/几何假设沿用前题：烟幕起爆瞬时球状、有效半径 $R=10$ m、起爆后 20 s 有效、云团以 $v_{\rm sink}=3$ m/s 向下匀速、弹体受重力 $g=9.8$ m/s²；无人机等高度匀速直线；导弹速度及初始位置按题面给定。

---

# 1. 符号与索引

* 无人机索引 $k\in\{1,\dots,5\}$（FY1–FY5），其初始位置为 $U_{0,k}$。
* 每架无人机可投放最多 $J_{\max}=3$ 枚弹；对第 $k$ 架的第 $j$ 枚弹，用索引 $ (k,j)$， $j\in\{1,\dots,J_{\max}\}$。
* 来袭导弹索引 $m\in\{1,2,3\}$（M1,M2,M3），每枚导弹初始位置 $M_{0,m}$，速度 $v_{m}$（题面常数）。
* 目标（真目标）位置取参考点 $T$（例如圆柱中心）；同前题。

---

# 2. 决策变量（设计变量）

连续变量与二值/整数变量：

**每架无人机（共同变量）**

* 航向角 $\alpha_k\in[0,2\pi)$（度制输出时乘以 $180/\pi$）。
* 飞行速度 $v_{u,k}\in[70,140]$ m/s。

**每枚烟幕（若不投放，对应变量可置为“无”）**

* 发射开关 $y_{k,j}\in\{0,1\}$，1 表示投放第 $j$ 枚，0 表示不投放。每机约束 $\sum_j y_{k,j}\le 3$。
* 投放时刻 $t_{r,k,j}\ge0$（若 $y_{k,j}=0$ 可忽略）。
* 起爆延时（引信） $\Delta_{k,j}\ge0$。
* （可选）指定“目标偏好”或分配变量 $a_{k,j,m}\in\{0,1\}$：如果该弹主要用于干扰导弹 $m$ 则 $a_{k,j,m}=1$；也可允许多个 $a_{k,j,m}$ 为 1（用于记录/约束）。 若不使用显式二元分配，可后处理判定主干扰目标。

因此总体决策向量含连续变量 $\{\alpha_k,v_{u,k},t_{r,k,j},\Delta_{k,j}\}$ 与若干离散变量 $y_{k,j}$（和可选 $a_{k,j,m}$）。这是一个 **混合整数非线性优化问题 (MINLP)**。

其他导出量（由决策变量决定）：

* 投放点 $S_{k,j}=U_k(t_{r,k,j})$；
* 起爆位置（云团初心）

$$
C_{0,k,j}=S_{k,j}+v_{u,k}\hat u_{u,k}\Delta_{k,j}+\tfrac12(0,0,-g)\Delta_{k,j}^2,
$$

* 起爆时刻 $t_{e,k,j}=t_{r,k,j}+\Delta_{k,j}$。

---

# 3. 约束（必须满足）

1. 每机速度与角度界： $70\le v_{u,k}\le140$。
2. 每机弹数： $y_{k,j}\in\{0,1\},\ \sum_{j=1}^{3} y_{k,j}\le3$。
3. 同机投放时间间隔： 对任意 $j_1<j_2$ 且 $y_{k,j_1}=y_{k,j_2}=1$，有 $t_{r,k,j_2}-t_{r,k,j_1}\ge 1\ \mathrm{s}$。
4. 起爆高度可行性： 若 $y_{k,j}=1$ 则 $z(C_{0,k,j}) \ge 0$。
5. 起爆时间需在导弹影响前： 对每被干扰的导弹 $m$，应要求 $t_{e,k,j} \le t_{\text{impact},m}$（导弹到达目标的时间），或在全局上设 $t_{e,k,j}\le T_{\max}$。
6. UAV 最小安全间距（可选强制）： 对任意 $k\ne k'$ 与时间 $t$， $\|U_k(t)-U_{k'}(t)\|\ge S_{\rm safe}$（例如 10–20 m），或把其作为惩罚项以便优化器处理。
7. 二元约束 $a_{k,j,m}\in\{0,1\}$（如果引入），并约束 $\sum_m a_{k,j,m}\ge y_{k,j}$（每投放弹至少有一个目标分配）或 $\sum_m a_{k,j,m}\le 1$（每弹分配单一主要目标）。

---

# 4. 运动学与几何关系（与问题1一致）

* 无人机单位向量： $\hat u_{u,k}=(\cos\alpha_k,\sin\alpha_k,0)$。
* 无人机轨迹： $U_k(t)=U_{0,k}+v_{u,k}\hat u_{u,k}t$.
* 导弹 m 的轨迹： $M_m(t)=M_{0,m}+v_{m}\hat u_{m} t$（指向假目标）。
* 云团在起爆后 $ \tau\in[0,20]$ 秒内的位置：

$$
C_{k,j}(t)=C_{0,k,j} + (0,0,-v_{\rm sink})(t-t_{e,k,j}),\quad t\in[t_{e,k,j},t_{e,k,j}+20].
$$

---

# 5. 遮蔽判定（多导弹、多云团）

定义点到线段最短距离函数与投影（同问题1）：

对于给定导弹 $m$ 与云团 $(k,j)$ 在时刻 $t$，计算投影参数

$$
s^*_{k,j,m}(t)=\frac{(C_{k,j}(t)-M_m(t))\cdot (T-M_m(t))}{\|T-M_m(t)\|^2},
$$

截断到 $[0,1]$ 得 $s_{\text{clamp}}$ 与最近点 $P_{k,j,m}(t)$。距离

$$
d_{k,j,m}(t)=\|C_{k,j}(t)-P_{k,j,m}(t)\|.
$$

若 $t\in[t_{e,k,j},t_{e,k,j}+20]$ 且 $d_{k,j,m}(t)\le R$，则云团 $(k,j)$ 在时间 $t$ 对导弹 $m$ 形成遮蔽。

对每一导弹 $m$ 定义云团并集遮蔽指示

$$
\chi_m(t)=\max_{k,j} \mathbf{1}\{t\in[t_{e,k,j},t_{e,k,j}+20]\ \wedge\ d_{k,j,m}(t)\le R\}.
$$

（并集含义：若任一云团在该时刻遮蔽，则导弹 $m$ 被遮蔽。）

---

# 6. 目标函数（优化目标）

首要目标：**最大化三枚导弹被有效遮蔽的总时间之和（或加权和）**，即

$$
\max \; J_{\text{total}}(x) \;=\; \sum_{m=1}^3 w_m \, T_{\text{shield},m}(x)
$$

其中

$$
T_{\text{shield},m}(x)=\int_{0}^{\infty} \chi_m(t;x)\,dt
$$

为导弹 $m$ 的遮蔽并集时长；$w_m\ge0$ 为优先权重（通常取 1，若某导弹优先防护可放大对应 $w_m$）。

可选的次要/复合目标：

* 最小化“资源成本” (总投放数 $\sum_{k,j} y_{k,j}$)；
* 最小化云团时空重叠以避免浪费（惩罚项 $ \sum_{k,j}\sum_{k',j'} \text{overlap}(k,j;k',j')$）；
* 多目标：同时最大化 $J_{\text{total}}$ 并最小化总投放数，可用加权和或 Pareto 优化处理。

完整单目标形式（带惩罚）：

$$
\max_x\; J(x) = \sum_{m=1}^3 w_m T_{\text{shield},m}(x) - \lambda_1 \sum_{k,j} y_{k,j} - \lambda_2 \text{overlap\_penalty}(x),
$$

并受上述约束。

---

# 7. 问题性质与求解方法建议

该问题为 **高维、混合整数、非凸、非光滑** 优化问题。直接求全局最优是计算密集的。下面列出实用可行的求解策略、分解思路与启发式算法。

## A. 直接 MINLP（小规模求解尝试）

* 若要精确求解，把问题建成 MINLP 并用商用求解器（e.g., BARON、Couenne、BONMIN）尝试，但这些对高维和非线性几何约束通常很慢且常常不可行。

## B. 两阶段/分解式启发（推荐，工程可行）

**阶段 1：时空需求规划（任务分配）**

* 在“导弹时间轴”上把每个导弹的关键危险窗口（例如导弹到达目标前的 $T_w$ 秒段）离散化。把每枚云团视为长度 ≤20s 的覆盖片段，目标是在这条时间轴上为每导弹安排覆盖片段的并集最大化。这个调度问题可用整数规划（0/1 覆盖选择）或贪心算法解决，得到一组“理想云团中心时间 + 位置区间” $ \{(t_{e}^\ast, C_0^\ast)\}$（不考虑 UAV 可达性）。
  **阶段 2：部署可行化（分配 & 轨迹映射）**
* 将阶段 1 生成的云团需求分配给具体 UAV：解决 assignment + feasibility 问题（给定目标 $C_0^\ast,t_e^\ast$，找到 UAV $k$ 与投放时刻 $t_r$、速度 $v_{u,k}$、航向 $\alpha_k$ 使得弹体在 $\Delta$ 时间后落到 $C_0^\ast$（或尽量接近）。这是一个连续的逆向逼近问题，可通过最小化位置误差（欧氏距离）来判可行性；若不可行则把某些云团重新调度或由其它 UAV 执行。
  **优势**：大幅降维；把离散调度与连续可行化分开，工程上更容易实现。

## C. 黑箱全局优化（整合式）

* 使用进化算法（差分进化 / CMA-ES / GA）或粒子群（PSO）处理连续变量，同时把离散变量 $y_{k,j}$ 用整型编码（或用实数编码加阈值化）。并行评估候选解（每个候选一次仿真）非常重要。
* 可先用较粗采样（时间步长较大）做初始搜索，再用精化评估对最好解精修。

## D. 混合启发（推荐实际做法）

1. 先在导弹时间窗口上进行**覆盖调度**得到希望起爆时间/位置；
2. 然后用 **车辆路径/指派 + 连续优化**（如最小二乘拟合或局部优化）把这些任务分配到 UAV，并用差分进化或 CMA-ES 对每架 UAV 的（$\alpha_k,v_{u,k}$）及其所承担的 $t_{r,k,j},\Delta_{k,j}$ 做本地优化。
3. 在关键步骤用约束投影（确保安全间距与高度合法）与惩罚项修正不可行解。

---

# 8. 数值细节与实现建议

* **时间采样**：总体评估时对每导弹 m 在其相关时间区间做采样（起始 $\min t_{e,k,j}$，结束 $\max (t_{e,k,j}+20)$），初筛用 $\Delta t=0.05$–0.1 s，精化 $\Delta t=0.005$–0.02 s。
* **遮蔽并集计算**：更高效且精确的实现办法是对每云团求出它对每导弹的遮蔽区间（求 $d_{k,j,m}(t)\le R$ 所对应的时间区间，使用根求法细化边界），然后对这些区间做并集（区间并操作），得到每导弹的精准并集时长。相较于纯采样并集，这更精确且更节省后处理成本。
* **并行化**：评估函数（一个候选解）可并行计算每云团/导弹组合的 $d$ 值及遮蔽区间，且优化算法个体/种群评估可分布式运行。
* **惩罚与可行化**：对不满足起爆高度、UAV 安全间距等约束的候选解，给出大负惩罚值而非硬拒绝（能帮助进化搜索快速避开不可行域）。
* **初始猜测（启发式）**：把 UAV 指向各导弹来向（或在各自附近均匀分布航向），速度设中值；把弹的起爆时刻安排在导弹到达目标前的关键临近段并使初爆点靠近导弹—目标线段靠近目标端（通常能获得较长遮蔽）。这些启发可显著提升搜索效率。

---

# 9. 输出映射到 `result3.xlsx`（模板字段填充规则）

模板每一行对应一枚弹，行字段填写方式如下：

* **无人机编号**：FY1..FY5（重复 3 行/机，若某行对应 $y_{k,j}=0$ 可留空或标注“不投放”）。
* **无人机运动方向**： $\alpha_k$（以度表示，取 0–360，x 轴正向逆时针为正）。
* **无人机运动速度 (m/s)**： $v_{u,k}$。
* **烟幕干扰弹编号**： $j=1,2,3$。
* **烟幕干扰弹投放点 (x,y,z)**： $S_{k,j} = U_k(t_{r,k,j})$（若没投放，可留空）。
* **烟幕干扰弹起爆点 (x,y,z)**： $C_{0,k,j}$。
* **有效干扰时长 (s)**： 单枚弹对其“主要被干扰导弹”（下面字段）贡献的遮蔽时长 $T_{k,j,\text{primary}}$，或也可以写该弹对所有导弹的总贡献（若多导弹同时受干扰，可在备注列写多目标贡献）。
* **干扰的导弹编号**： 填写该弹的**主要目标导弹编号 m**（若该弹同时有效干扰多枚导弹，可在该格写例如 “1,2” 或只写主要受益导弹，具体按你要的格式）。

**另外建议在输出文件中添加附表**（sheet）：

* `summary`：每导弹 $m$ 的并集遮蔽时长 $T_{\text{shield},m}$ 与总并集时长（若需要组合度量）。
* `params`：每架 UAV 的 $\alpha_k,v_{u,k}$ 与其投放的所有 $t_{r,k,j},\Delta_{k,j}$。
* `intervals`：每枚弹对每导弹的具体遮蔽时间段（起止时刻），便于验证。

---

# 10. 伪代码（评估器 + 优化框架示例）

```
# 已知: for k=1..5 U0_k, for m=1..3 M0_m,v_m, T
# Variables: alpha_k, v_u_k, {y_kj, t_r_kj, Delta_kj}

def compute_C0_and_te(k,j):
    if y_kj==0: return None
    hat_u = (cos(alpha_k), sin(alpha_k), 0)
    S = U0_k + v_u_k * hat_u * t_r_kj
    C0 = S + v_u_k * hat_u * Delta_kj + 0.5*(0,0,-g)*Delta_kj**2
    te = t_r_kj + Delta_kj
    return C0, te

def eval_candidate(x):
    # compute all C0_kj and te; check feasibility (z>=0 etc.)
    intervals_by_m = {m: [] for m in (1,2,3)}
    for each (k,j) with y_kj==1:
        C0, te = compute_C0_and_te(k,j)
        if not feasible -> return large_penalty
        # For each missile m, find times t in [te, te+20] where d_kjm(t) <= R
        for m in 1..3:
            roots = solve_d_eq_R_and_find_intervals(Ck(t), M_m(t), T, t in [te, te+20])
            # roots gives zero or more intervals
            intervals_by_m[m].extend(roots)
    # For each m, merge intervals_by_m[m] -> union intervals, compute length T_shield_m
    J_total = sum_m w_m * length(union_intervals_m)
    # optional penalty terms
    return J_total - lambda1 * sum(y_kj) - lambda2 * overlap_penalty(...)

# optimization: use DE/CMA-ES on continuous vars and treat y_kj as integer via rounding/threshold
best = differential_evolution(lambda x: -eval_candidate(x), bounds)
# refine best with local search and high-precision interval merging
```

函数 `solve_d_eq_R_and_find_intervals`：对每 (k,j,m) 求解方程 $d_{k,j,m}(t)^2-R^2=0$ 在区间 $[t_{e,k,j}, t_{e,k,j}+20]$ 的根并返回满足不等式的时间片段（可用二分/Brent 在分段单调区间求根）。

---

# 11. 鲁棒性、不确定性与验证建议

* **风/扰动**：若想引入风或弹体随机横向漂移，用蒙特卡罗（多次随机样本）评估期望遮蔽时长并优化期望或下分位（如 5% 分位）。
* **参数灵敏度**：对关键参数（速度、投放时刻、引信延时）做灵敏度分析，找出系统最敏感的参数以指导容错设计。
* **可视化**：绘制每导弹随时间的遮蔽函数 $\chi_m(t)$、每弹的遮蔽区间图与三维轨迹（导弹轨迹、UAV轨迹、云团中心）以验证解的物理直观性。
* **安全验证**：检查无人机间的最小距离曲线，确保无碰撞风险。若有风险，加硬性约束再优化。

---

# 12. 求解工具建议与工程实践提示

* 全局搜索：**差分进化 (DE)**、**CMA-ES**、**遗传算法 (GA)**。
* 局部精化：**Nelder–Mead**、**Powell**、对平滑近似使用 L-BFGS-B。
* 混合：先用离散调度+连续可行化（两阶段）再用 DE 对最有希望的方案精修。
* 并行化：优化时每个候选解或个体评估独立，极易并行（多核或分布式）。
* 工具栈：Python + numpy/scipy + multiprocessing；或使用 C++ 并行库加速。若要解整数规划子问题，可用 CPLEX/Gurobi/GLPK 做分配步骤。

---

# 13. 交付物与表格填写说明（最终到 `result3.xlsx`）

* 对每架 UAV（FY1–FY5）每枚弹（1–3）在表内填入：无人机方向（度）、速度、弹编号、投放点 $S_{k,j}$ 的 $(x,y,z)$、起爆点 $C_{0,k,j}$ 的 $(x,y,z)$、单弹“有效干扰时长”以及该弹主要干扰的导弹编号（或列出所有受影响导弹）。
* 在 `summary` sheet 中写出：每导弹 $m$ 的并集遮蔽总时长 $T_{\text{shield},m}$、整体加权目标值 $J_{\text{total}}$、总投放弹数、任何约束违规说明。
* 在 `intervals` sheet 中列出每弹对每导弹的遮蔽时间段（起始/结束），便于审阅与验证。

---

# 14. 小结（工程要点）

* 问题 5 是一个 **混合整数、非凸、非光滑** 的调度 + 连续几何配位问题。实用做法是把问题分解为（1）时间/覆盖调度（离散）与（2）UAV 可行化/参数优化（连续），并使用全局启发式算法（DE/CMA-ES）结合局部精化来求解。
* 实现要点：对每枚云团与每枚导弹用根求法得到精确遮蔽区间并做并集运算；并行化评估以加快全局搜索；把安全/高度等硬约束纳入候选解筛选或惩罚函数中。
* 输出按 `result3.xlsx` 模板填入每行对应的物理坐标、时刻与单枚贡献，并在附表中给出每导弹的并集遮蔽时长（最终评价指标）。

---

如果你希望，我可以立刻将上面的伪代码与评估器**翻成结构良好的 Python 模板（不含运行结果）**，并附上写入 `result3.xlsx`（含 summary & intervals sheet）的代码框架，便于你直接运行与替换求解器。要不要我现在把这个 Python 模板生成出来？
